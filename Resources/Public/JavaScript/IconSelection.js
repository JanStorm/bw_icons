define(["jquery","TYPO3/CMS/Backend/Modal.js","@typo3/Core/Ajax/AjaxRequest"],(function(t,e,i){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var a=n(t),d=n(e),s=n(i);return class{onModalButtonClick(t){let e=TYPO3.settings.ajaxUrls.icon_selection;e+=e.indexOf("?")>0?"&":"?",e+="P[pid]="+this.pid,e+="&P[iconProviders]="+this.iconProviders,d.default.advanced({type:d.default.types.ajax,content:e,size:d.default.sizes.large,title:TYPO3.lang.icon_wizard_title,callback:t=>{this.currentModal=t},ajaxCallback:this.onModalLoaded.bind(this),buttons:[{text:TYPO3.lang.icon_wizard_save,name:"save",icon:"actions-document-save",active:!0,btnClass:"btn-primary",dataAttributes:{action:"save"},trigger:this.onModalSave.bind(this)}]})}onModalSave(){const t=a.default(this.currentModal).find('*[data-icon-name="'+this.selectedIconName+'"]').clone();a.default(this.$hiddenElement).val(this.selectedIconName),a.default(this.$formElement).find(".input-icon-holder").html(t),this.selectedIconName&&a.default(this.$formElement).find(".close").css("visibility","visible"),this.currentModal.hideModal()}onClearButtonClick(t){a.default(this.$formElement).find(".input-icon-holder").html(""),a.default(this.$formElement).find(".close").css("visibility","hidden"),a.default(this.$hiddenElement).val("")}onModalLoaded(){a.default(this.currentModal).find("a.thumbnail").on("click",this.onIconClick.bind(this)),a.default(this.currentModal).find(".nav-tabs a").on("click",this.onNavTabClick.bind(this)),a.default(this.currentModal).find("input.search").on("input",this.onFilterInput.bind(this)),a.default(this.currentModal).find(".close").on("click",this.onFilterResetClick.bind(this))}onFilterResetClick(t){a.default(t.currentTarget).parent().find(".search").val(""),a.default(this.currentModal).find("input.search").trigger("input")}onFilterInput(t){const e=a.default(t.currentTarget).val(),i=a.default(t.currentTarget).closest(".tab-content");i.find(".griditem").removeClass("hidden"),i.find("h1").removeClass("hidden"),i.find(".list-group-item").removeClass("hidden"),i.find(".icongrid").removeClass("hidden"),i.find(".close").css("visibility","hidden"),e&&(i.find("*[data-icon-name]").parent().parent().addClass("hidden"),i.find('*[data-icon-base-name*="'+e+'"]').parent().parent().removeClass("hidden"),i.find(".close").css("visibility","visible")),a.default(".list-group-item",i).each((function(t,e){const n=a.default(e).attr("href").substr(1),d=i.find('h1[id="'+n+'"] + .icongrid .griditem:not(.hidden)').length;a.default("span",e).html(d),0===d&&(i.find('h1[id="'+n+'"]').addClass("hidden"),i.find('h1[id="'+n+'"] + .icongrid').addClass("hidden"),a.default(e).addClass("hidden"))})),a.default("h1:not([id]) span",i).html(i.find(".griditem:not(.hidden)").length)}onNavTabClick(t){t.preventDefault();const e=a.default(t.currentTarget).attr("href").substr(1);a.default(this.currentModal).find(".nav-tabs li, .nav-tabs li a").removeClass("active"),a.default(this.currentModal).find('.nav-tabs a[href="#'+e+'"]').addClass("active").parent().addClass("active"),a.default(this.currentModal).find(".tab-content").removeClass("active"),a.default(this.currentModal).find(".tab-content#"+e).addClass("active")}onIconClick(t){t.preventDefault(),a.default(this.currentModal).find("a.thumbnail").removeClass("active"),this.selectedIconName=a.default(t.currentTarget).children().first().attr("data-icon-name"),a.default(t.currentTarget).addClass("active")}injectStyleSheets(t){t.forEach((t=>{this.editor&&this.editor.document.$.head.insertAdjacentHTML("beforeend",'<link rel="stylesheet" href="'+t+'" />'),parent.document.querySelector('link[href*="'+t+'"]')||parent.document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeend",'<link rel="stylesheet" href="'+t+'" />')}))}loadAndIncludeStylesheets(){let t=TYPO3.settings.ajaxUrls.icon_stylesheets;t+=t.indexOf("?")>0?"&":"?",t+="pid="+this.pid,new s.default(t).get().then((async t=>{const e=await t.resolve();this.injectStyleSheets(e)}))}rteButtonClick(){const t=this.editor.config.IconPicker.routeUrl;d.default.advanced({type:d.default.types.ajax,content:t,size:d.default.sizes.large,title:this.editor.lang.IconPicker.modalTitle,callback:t=>this.currentModal=t,ajaxCallback:this.onModalLoaded.bind(this),buttons:[{text:this.editor.lang.IconPicker.save,name:"save",icon:"actions-document-save",active:!0,btnClass:"btn-primary",dataAttributes:{action:"save"},trigger:this.onRteModalSave.bind(this,this.editor)}]})}onRteModalSave(t){if(this.selectedIconName){const e=a.default(this.currentModal).find('*[data-icon-name="'+this.selectedIconName+'"]').get(0),i=new CKEDITOR.dom.element(e);t.insertElement(i),t.focus()}this.currentModal.trigger("modal-dismiss")}initForFormElement(t){this.loadAndIncludeStylesheets(),this.itemFormElName=t,this.$formElement=a.default('div[data-form-element="'+t+'"]'),this.$hiddenElement=a.default('input[name="'+t+'"]'),a.default(this.$formElement).find(".t3js-form-field-iconselection").on("click",this.onModalButtonClick.bind(this)),a.default(this.$formElement).find(".close").on("click",this.onClearButtonClick.bind(this))}initForRteEditor(t){this.editor=t,this.loadAndIncludeStylesheets()}constructor(t,e,i){this.pid=t,this.iconProviders=e,this.initForFormElement(i)}}}));
