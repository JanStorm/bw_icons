import*as a from"@ckeditor/ckeditor5-core";import*as s from"@ckeditor/ckeditor5-ui";import i from"@typo3/backend/modal.js";import l from"@typo3/core/ajax/ajax-request.js";import{html as d}from"lit";var n=class r extends a.Plugin{init(){let e=this.editor;this.registerTypo3Icon(e),this.registerTypo3FontIcon(e),e.ui.componentFactory.add(r.pluginName,t=>{let o=new s.ButtonView(t);return o.label="Icon Picker",o.icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38 38"><path d="M29.55 1.6H9.05A7.48 7.48 0 0 0 1.6 9.05v20.5c0 4.1 3.35 7.45 7.45 7.45h20.5c4.1 0 7.45-3.35 7.45-7.45V9.05c0-4.1-3.35-7.45-7.45-7.45Zm4.1 27.95c0 2.23-1.83 4.1-4.1 4.1H9.05a4.11 4.11 0 0 1-4.1-4.1V9.05c0-2.24 1.83-4.1 4.1-4.1h20.5c2.23 0 4.1 1.83 4.1 4.1v20.5Z"/><path d="M16.43 13.93a3.17 3.17 0 1 0-6.33 0 3.17 3.17 0 0 0 6.33 0Z"/><path d="M28.47 13.93a3.17 3.17 0 1 1-6.34 0 3.17 3.17 0 0 1 6.34 0Z"/><path d="M23.62 21.53h-8.65c-.74 0-1.41.38-1.82 1.01-.41.6-.45 1.38-.19 2.01a6.94 6.94 0 0 0 6.3 4.14c2.72 0 5.22-1.6 6.3-4.14.3-.67.22-1.41-.19-2.01-.33-.63-1-1-1.75-1Z"/></svg>',o.on("execute",()=>this.openWizardModal()),o}),this.loadAndIncludeStylesheets()}guessPid(){let e=this.editor.config.get("typo3link")?.routeUrl;if(e){let t=/(?:\&P\[pid\]\=)\d+/gi,o=decodeURIComponent(e);return parseInt(o.match(t)[0].substring(8))}return 0}onModalSave(){window.parent.TYPO3.Modal.dismiss();let e=window.parent.frames.list_frame.window.SELECTED_ICON??null;e&&(e.isFontIcon?editor.model.change(t=>{let o=t.createElement("typo3fonticon",{class:e.value,iconName:e.title,iconBaseName:e.title});editor.model.insertObject(o)}):editor.model.change(t=>{let o=t.createElement("typo3icon",{src:e.imgSrc,iconName:e.title,iconBaseName:e.title,loading:"lazy",alt:e.title,role:"presentation"});editor.model.insertObject(o)}),this.editor.focus())}getWizardConfig(){return{pid:this.guessPid(),iconProviders:[]}}openWizardModal(){let t="typo3icon",o=JSON.stringify(this.getWizardConfig());i.advanced({additionalCssClasses:["modal-bw-icon"],buttons:[{btnClass:"btn-default",name:"dismiss",icon:"actions-close",text:window.parent.TYPO3.lang["button.cancel"],trigger:()=>window.parent.TYPO3.Modal.dismiss()},{btnClass:"btn-primary",name:"save",icon:"actions-document-save",text:window.parent.TYPO3.lang.icon_wizard_save,trigger:this.onModalSave.bind(this)}],content:d`
        <bw-icon-wizard
          class="w-100" itemFormElName="${t}" wizardConfig="${o}" itemFormElValue=""></bw-icon-wizard>`,size:i.sizes.large,title:window.parent.TYPO3.lang.icon_wizard_title,style:null,staticBackdrop:!0})}registerTypo3Icon(e){e.model.schema.register("typo3icon",{inheritAllFrom:"$inlineObject",allowIn:"$text",allowAttributes:["src","iconName","iconBaseName","loading","alt","role"]}),e.conversion.for("upcast").elementToElement({view:{name:"img",attributes:["src"]},model:(t,{writer:o})=>o.createElement("typo3icon",{src:t.getAttribute("src")||"",iconName:t.getAttribute("data-icon-name")||"",iconBaseName:t.getAttribute("data-icon-base-name")||"",loading:t.getAttribute("loading")||"",alt:t.getAttribute("alt")||"",role:t.getAttribute("role")||""})}),e.conversion.for("downcast").elementToElement({model:{name:"typo3icon",attributes:["src"]},view:(t,{writer:o})=>o.createEmptyElement("img",{src:t.getAttribute("src"),"data-icon-name":t.getAttribute("iconName"),"data-icon-base-name":t.getAttribute("iconBaseName"),loading:t.getAttribute("loading"),alt:t.getAttribute("alt"),role:t.getAttribute("role")})})}registerTypo3FontIcon(e){e.model.schema.register("typo3fonticon",{inheritAllFrom:"$inlineObject",allowIn:"$text",allowAttributes:["iconName","iconBaseName","class"]}),e.conversion.for("upcast").elementToElement({view:{name:"i",classes:!0},model:(t,{writer:o})=>o.createElement("typo3fonticon",{iconName:t.getAttribute("data-icon-name")||"",iconBaseName:t.getAttribute("data-icon-base-name")||"",class:t.getAttribute("class")||""})}),e.conversion.for("downcast").elementToElement({model:{name:"typo3fonticon",attributes:["class"]},view:(t,{writer:o})=>o.createEmptyElement("i",{"data-icon-name":t.getAttribute("iconName"),"data-icon-base-name":t.getAttribute("iconBaseName"),class:t.getAttribute("class")})})}async loadAndIncludeStylesheets(){let e=TYPO3.settings.ajaxUrls.icon_stylesheets,t=this.getWizardConfig();new l(e).post(t).then(async o=>{(await o.resolve()).forEach(c=>{document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeend",'<link rel="stylesheet" href="'+c+'" />')})})}};n.pluginName="IconPicker";export{n as default};
